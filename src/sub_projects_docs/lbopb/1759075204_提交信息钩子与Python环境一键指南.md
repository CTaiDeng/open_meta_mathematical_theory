# 提交信息钩子与 Python 环境一键指南

- 作者：GaoZheng
- 日期：2025-09-29
- 版本：v1.0.0

## 摘要
本文档用于跨项目复用：在任意 Git 仓库中，快速完成 Python 环境初始化，并启用“提交信息自动生成钩子”（支持访问 Gemini API，无密钥时本地降级）。

---

— 本文以当前仓库为模板，其他项目可按“跨项目复用”章节复制文件与命令即可。

## 目标

- 一键创建/激活虚拟环境并安装依赖（含可选 google-generativeai）。
- 启用 `prepare-commit-msg` 钩子，自动生成提交信息。
- 支持优先使用 Gemini API（`GEMINI_API_KEY`/`GOOGLE_API_KEY`/`GOOGLEAI_API_KEY`），无密钥时自动降级为本地摘要。

## 在本仓库快速启用

1) 初始化 Python 环境（Windows）

```bat
my_scripts/setup_python_env.cmd --tests
:: 可选：--envdir <dir>  --requirements <path>  --no-torch  --trace
```

2) 启用钩子目录与提交模板

```bash
git config core.hooksPath .githooks
git config commit.template .githooks/.git-commit-template.txt
```

3) 配置 API Key（任选其一；设置后需重开终端）

- Windows（PowerShell）：

```powershell
setx GEMINI_API_KEY "<your_key>"
# 可选：setx GEMINI_MODEL "gemini-1.5-flash"
```

- Linux/macOS：

```bash
export GEMINI_API_KEY="<your_key>"
# 可选：export GEMINI_MODEL="gemini-1.5-flash"
```

4) 验证

```bash
git config --get core.hooksPath          # 期望输出 .githooks
git config --get commit.template         # 期望输出 .githooks/.git-commit-template.txt
```

执行一次提交流程（随便改动一个文件并暂存）：

```bash
git add <some-file>
git commit
# 若配置成功：将自动生成中文提交信息；无密钥将回退为“update”。
```

提示：临时跳过钩子可用 `git commit --no-verify`。

## 跨项目复用（推荐做法）

将以下文件从本仓库复制到目标项目根目录（保持相对路径）：

- `.githooks/prepare-commit-msg`
- `.githooks/.git-commit-template.txt`
- `scripts/gen_commit_msg_googleai.py`

然后在目标项目执行：

```bash
git config core.hooksPath .githooks
git config commit.template .githooks/.git-commit-template.txt
```

为确保钩子可运行，目标项目建议也建立虚拟环境（Windows）：

```bat
:: 复制本仓库的 my_scripts/setup_python_env.cmd 到目标项目根目录后执行
my_scripts/setup_python_env.cmd --tests
```

或在 Linux/macOS：

```bash
python3 -m venv .venv && . .venv/bin/activate
pip install -U pip setuptools wheel
pip install -U numpy google-generativeai
```

最后按“在本仓库快速启用”的第 3 步设置 API Key 即可。

## 工作机制简述

- 钩子：`.githooks/prepare-commit-msg`
  - 若提交信息为空/为 `update`，调用 `scripts/gen_commit_msg_googleai.py` 生成。
  - 解释器选择顺序：`.venv/Scripts/python.exe` → `.venv/bin/python` → `python3` → `python` → `py -3`。
  - 透传 `GEMINI_API_KEY/GOOGLE_API_KEY/GOOGLEAI_API_KEY` 环境变量。
  - 生成失败时写入占位 `update`，不阻塞提交。

- 生成器：`scripts/gen_commit_msg_googleai.py`
  - 有密钥：使用 Gemini API 生成简洁的中文提交信息。
  - 无密钥或导入失败：输出 `update`。
  - 对“仅注释/空白改动”自动写入 `update`。

## 常见问题

- 提交时无任何自动信息？
  - 检查 `git config --get core.hooksPath` 是否为 `.githooks`。
  - 确认钩子脚本有可执行权限（Linux/macOS：`chmod +x .githooks/prepare-commit-msg`）。
  - 确认 `scripts/gen_commit_msg_googleai.py` 路径无误。

- 提示无法访问 API？
  - 检查是否设置了 `GEMINI_API_KEY`（或 `GOOGLE_API_KEY/GOOGLEAI_API_KEY`）。
  - 网络受限时会自动降级为本地占位 `update`。

- Python 找不到或虚拟环境未激活？
  - 先执行 `my_scripts/setup_python_env.cmd`（Windows）或手工用 `python3 -m venv .venv` 创建后安装依赖。

## 附：相关文件

- `my_scripts/setup_python_env.cmd`：Windows 下一键创建虚拟环境并安装依赖（含可选 google-generativeai、PyTorch CPU）。
- `.githooks/prepare-commit-msg`：提交信息生成钩子。
- `.githooks/.git-commit-template.txt`：提交模板，占位为 `update`。
- `scripts/gen_commit_msg_googleai.py`：提交信息生成器（Gemini API / 本地降级）。

---

**许可声明 (License)**

Copyright (C) 2025 GaoZheng

本文档采用[知识共享-署名-非商业性使用-禁止演绎 4.0 国际许可协议 (CC BY-NC-ND 4.0)](https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh-Hans)进行许可。
